---
title: "Intermediate Phylotranscriptomics Analyses"
author: "Hajk-Georg Drost"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intermediate Phylotranscriptomics Analyses}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r, echo = FALSE, message = FALSE}
library(myTAI)
options(width = 750)
knitr::opts_chunk$set(
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
```

In the Introduction vignette you learned how to perform the most fundamental computations
and visualizations for phylotranscriptomics analyses using the `myTAI` package.

This __Intermediate__ vignette will provide you more detailed analyses and more specialized techniques 
to investigate the observed phylotranscriptomics patterns (`TAI`, `TDI`, `RE`, etc.).


## Investigating the statistical significance of phylotranscriptomic patterns

Three methods have been proposed to quantify the statistical significance of the observed phylotranscriptomics patterns
(Quint et al. 2012, Drost et al., 2014).

* __FlatLineTest__
* __ReductiveHourglassTest__
* __EarlyConservationTest__

Here, we will build the test statistic of each test step by step so that future modifications
or new test statistics can be built upon the existing methods implemented in the `myTAI` package.



### FlatLineTest

The FlatLineTest is a permutation test quantifying the statistical significance of a phylotranscriptomic pattern
to deviate from a flat line. The goal is to detect any evolutionary signal within a developmental time course that significantly deviates from a flat line.

To build the test statistic we start with a standard PhyloExpressionSet.
The `myTAI` package provides an example PhyloExpressionSet named `PhyloExpressionSetExample`:

```{r}
library(myTAI)

# load an example PhyloExpressionSet stored in the myTAI package
data(PhyloExpressionSetExample) 

# look at the standardized data set format
head(PhyloExpressionSetExample, 3) 
```

As you can see the first column of the `PhyloExpressionSetExample` stores the Phylostratum assignments of the corresponding genes.
The permutation test is based on random sampling of the Phylostratum assignment of genes. The underlying assumption is that
the `TAI` profile of correctly assigned Phylostrata is significantly deviating from `TAI` profiles based on randomly assigned Phylostrata.

```{r}
# TAI profile of correctly assigned Phylostrata
TAI(PhyloExpressionSetExample) 
```

Visualization: 

```{r, fig.width= 7, fig.height= 5}
# visualize the TAI profile of correctly assigned Phylostrata
PlotPattern(PhyloExpressionSetExample, type = "l", lwd = 6, p.value = FALSE) 
```


```{r}

# randomly permute the Phylostratum assignment of all genes 
randomPhyloExpressionSetExample <- data.frame( sample(PhyloExpressionSetExample[ , 1]), 
                                              PhyloExpressionSetExample[, 2:9] )

# TAI profile based on randomly assigned Phylostrata
TAI(randomPhyloExpressionSetExample) 
```

Visualization: 

```{r, fig.width= 7, fig.height= 5}
# visualize the TAI profile based on randomly assigned Phylostrata
PlotPattern(randomPhyloExpressionSetExample, type = "l", lwd = 6, p.value = FALSE) 
```

As you can see, the visual pattern of the correctly assigned `TAI` profile and the randomly assigned `TAI` profile differ qualitatively.

Now we investigate the variance of the two observed patterns.

```{r}
# variance of the TAI profile based on correctly assigned Phylostrata
var(TAI(PhyloExpressionSetExample)) 
```

```{r}
# variance of the TAI profile based on randomly assigned Phylostrata
var(TAI(randomPhyloExpressionSetExample)) 
```

We observe that the variance of the randomly assigned TAI profile is much smaller than the variance of the correctly assigned TAI profile. Here we use the variance to quantify the _flatness_ of a given TAI profile. In theory the variance of a perfect flat line would be zero. So any TAI profile that is close to zero would resemble a flat line. But how exactly are the variances of randomly assigned TAI profiles distributed. For this purpose the `bootMatrix()` function was implemented.

The `bootMatrix()` takes an PhyloExpressionSet or DivergenceExpressionSet as input and computes $N$ `TAI` or `TDI` profiles of based on randomly assigned Phylostrata or Divergence-Strata.

```{r}
# compute 1000 TAI profiles based on randomly assigned Phylostrata
randomTAIs <- bootMatrix(PhyloExpressionSetExample, permutations = 1000)

head(randomTAIs)

```


Based on this `booMatrix` we can compute the variance of each random TAI profile.



```{r, fig.width= 7, fig.height= 5}
# compute the variance of the random TAI profile for each row
variance_vector <- apply(randomTAIs, 1 , var)

# and visualize the distribution of variances
hist(variance_vector, breaks = 100)
```

Now it is interesting to see where we can find the variance of the correctly assigned TAI.


```{r, fig.width= 7, fig.height= 5}
# variance of the TAI profile based on correctly assigned Phylostrata
var_real <- var(TAI(PhyloExpressionSetExample)) 

# visualize the distribution of variances
hist(c(variance_vector,var_real), breaks = 100, 
     xlab = "variance", main = "Histogram of variance_vector")

# and plot a red line at the position where we can find the 
# real variance
abline(v = var_real, lwd = 5, col = "red")
```

This plot illustrates that variances based on random `TAI` profiles seem have a smaller variance than the variance based on the correct `TAI` profile. To obtain a p-value that now quantifies this difference, we need to fit the histogram of `variance_vector` with a specific probability distribution. 


Visually it would be possible to choose a gamma distribution to fit the histogram of `variance_vector`. To validate this choice a [Cullen and Frey graph](https://openlibrary.org/works/OL1978341W/Probabilistic_techniques_in_exposure_assessment) provided by the [fitdistrplus](http://cran.r-project.org/web/packages/fitdistrplus/index.html) package can be used.


```{r, fig.width= 7, fig.height= 5}
# install.packages("fitdistrplus")

# plot a Cullen and Frey graph
fitdistrplus::descdist(variance_vector)
```

Based on the observation that a gamma distribution is a suitable fit for `variance_vector`, we can now
estimate the parameters of the gamma distribution that fits the data.

```{r, fig.width= 7, fig.height= 5}
# estimate the parameters: shape and rate using 'moment matching estimation'
gamma_MME <- fitdistrplus::fitdist(variance_vector,distr = "gamma",method = "mme")
# estimate shape:
shape <- gamma_MME$estimate[1]
# estimate the rate:
rate <- gamma_MME$estimate[2]

# define an expression written as function as input for the curve() function
gamma_distr <- function(x){ return(dgamma(x = x,shape = shape,rate = rate)) }

# plot the density function and the histogram of variance_vector
curve(gamma_distr,
      xlim = c(min(variance_vector),max(c(variance_vector,var_real))),
      col = "steelblue",lwd = 5,xlab = "Variances", ylab="Frequency")

# plot the histogram of variance_vector
histogram <- hist(variance_vector,prob = TRUE,add = TRUE, breaks = 100)
rug(variance_vector)

# plot a red line at the position where we can find the real variance
abline(v = var_real, lwd = 5, col = "red")
```

Using the gamma distribution with estimated parameters the corresponding p-value of `var_real` can
be computed.

```{r}
# p-value of var_real
pgamma(var_real, shape = shape,rate = rate, lower.tail = FALSE)
```


Hence, the variance of the correct TAI profile significantly deviates from random TAI profiles 
and this allows us to assume that the underlying TAI profile captures a real evolutionary signal.

### Using the FlatLineTest() function

This entire procedure of computing the p-value having the variance of TAI profiles as test statistic is done by the `FlatLineTest()` function.

```{r}
# perform the FlatLineTest
FlatLineTest(PhyloExpressionSetExample, permutations = 1000)
```

This function returns the p-value of the test statistic.


Additionally the `FlatLineTest()` function alows to investigate the goodness
of the test statistic.


```{r, fig.width= 7, fig.height= 3}

# perform the FlatLineTest and investigate the goodness of the test statistic
FlatLineTest(PhyloExpressionSetExample, permutations = 1000, 
             plotHistogram = TRUE, parallel = TRUE)

```

The `plotHistogram` argument specifies whether analytics plots shall be drawn
to quantify the goodness of the test statistic returned by the `FlatLineTest`.
The `parallel` argument specifies that the corresponding computations are performed
by multicore processing. So in case you aren't working on a multicore machine,
please make sure you set `parallel = FALSE` (default).


The three resulting plots show:

* a [Cullen and Frey graph](https://openlibrary.org/works/OL1978341W/Probabilistic_techniques_in_exposure_assessment)

* a histogram of the test statistic and the corresponding [gamma distribution](http://en.wikipedia.org/wiki/Gamma_distribution) that
was fitted to the test statistic

* a plot showing the p-values (`p_flt`) for 10 individual runs.
Since the underlying test statistic is generated by a permutation test,
the last plot shows the influence of different permutations to the corresponding p-value

In other words, to test whether the underlying permutation of the permutation test
is causing the significance of the p-value, you can specify the `runs` argument
within the `FlatLineTest()` function to start more individual runs.
In case there exists a permutation that causes a previous significant p-value to
become non-significant, the corresponding phylotranscriptomics pattern shoudn't be considered as 
statistically significant.


### Reductive Hourglass Test

The Reductive Hourglass Test has been developed to statistically evaluate the existence of a phylotranscriptomic hourglass pattern based on TAI or TDI computations. 
The corresponding p-value quantifies the probability that a given TAI or TDI pattern (or any phylotranscriptomics pattern) does not follow an hourglass like shape. 
A p-value < 0.05 indicates that the corresponding phylotranscriptomics pattern does indeed follow an hourglass (high-low-high) shape.

To build the test statistic we start with a standard PhyloExpressionSet.
The `myTAI` package provides an example PhyloExpressionSet named `PhyloExpressionSetExample`:

```{r}
library(myTAI)

# load an example PhyloExpressionSet stored in the myTAI package
data(PhyloExpressionSetExample) 

# look at the standardized data set format
head(PhyloExpressionSetExample, 3) 
```

As you can see the first column of the `PhyloExpressionSetExample` stores the Phylostratum assignments of the corresponding genes.
The permutation test is based on random sampling of the Phylostratum assignment of genes. The underlying assumption is that
the `TAI` profile of correctly assigned Phylostrata is significantly deviating from `TAI` profiles based on randomly assigned Phylostrata.

```{r}
# TAI profile of correctly assigned Phylostrata
TAI(PhyloExpressionSetExample) 
```

Visualization: 

```{r, fig.width= 7, fig.height= 5}
# visualize the TAI profile of correctly assigned Phylostrata
PlotPattern(PhyloExpressionSetExample, type = "l", lwd = 6, 
            p.value = FALSE) 

```


The reductive hourglass test is a permutation test based on the following test statistic.

(1) A set of developmental stages is partitioned into three modules – early, mid, and late – based on prior biological knowledge.

(2) The mean TAI or TDI value for each of the three modules Tearly, Tmid, and Tlate are computed.

(3) The two differences D1 = Tearly - Tmid and D2 = Tlate - Tmid are calculated.

(4) The minimum D_min of D1 and D2 is computed as final test statistic of the reductive hourglass test.

In order to determine the statistical significance of an observed minimum difference Dmin the following permutation test was performed. Based on the bootMatrix Dmin is calculated from each of the permuted TAI or TDI profiles, approximated by a Gaussian distribution with method of moments estimated parameters returned by fitdist, and the corresponding p-value is computed by pnorm given the estimated parameters of the Gaussian distribution. The goodness of fit for the random vector Dmin is statistically quantified by a [Lilliefors (Kolmogorov-Smirnov) test](http://amstat.tandfonline.com/doi/abs/10.1080/00031305.1986.10475419#.VDjzFCl_vek) for normality.



To perform the __Reductive Hourglass Test__ you can use the `ReductiveHourglassTest()` function.
Using this function you need to devide the given phylotranscriptomics pattern into
three developmental modules:

* early module
* mid module
* late module

This can be done using the `modules` argument: `module = list(early = 1:2, mid = 3:5, late = 6:7)`.
In this example (`PhyloExpressionSetExample`) we devide the corresponding developmental process
into the three modules:

* early module: Stages 1 - 2 = Zygote and Quadrant
* mid module: Stages 3 - 5 = Globular, Heart, and Torpedo
* late module: Stages 6 - 7 = Bent and Mature


```{r, fig.width= 7, fig.height= 5}

# perform the Reductive Hourglass Test
ReductiveHourglassTest(PhyloExpressionSetExample,
                       modules = list(early = 1:2, mid = 3:5, late = 6:7)) 

```





